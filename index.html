<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>Simon Retro</title>
  <style>
    :root{
      --bg:#0b0f14;
      --frame:#111723;
      --bezel:#1b2433;
      --scan:#0d1117;
      --txt:#d6e1ff;
      --accent:#ffffff;
      --danger:#ff6b6b;

      --green:#2ecc71;
      --red:#e74c3c;
      --yellow:#f1c40f;
      --blue:#3498db;

      --green-lit:#6dff9a;
      --red-lit:#ff8a7f;
      --yellow-lit:#ffe16a;
      --blue-lit:#7ec8ff;
    }

    html,body{height:100%;}
    body{
      margin:0; background:radial-gradient(1200px 800px at 50% 20%, #121a26 0%, var(--bg) 60%);
      color:var(--txt); font:16px/1.4 system-ui, -apple-system, Segoe UI, Roboto, "Helvetica Neue", Arial, "Noto Sans", "Liberation Sans", sans-serif;
      display:flex; align-items:center; justify-content:center; padding:clamp(10px, 4vmin, 32px);
    }

    .shell{
      width:min(92vw, 560px);
      max-height:96vh;
      background:linear-gradient(145deg, var(--frame), #0f1420);
      border-radius:22px; padding:14px; box-shadow:
        0 20px 60px rgba(0,0,0,.45), inset 0 0 0 1px rgba(255,255,255,.03);
    }

    .screen{
      background:linear-gradient(180deg, var(--bezel), #0f151f);
      border-radius:18px; padding:16px; box-shadow: inset 0 2px 0 rgba(255,255,255,.03);
    }

    .crt{ background: radial-gradient(120% 80% at 50% 20%, #101828, var(--scan) 70%);
      border-radius:16px; padding:16px; position:relative; overflow:hidden;
      box-shadow: inset 0 0 0 1px rgba(255,255,255,.04), inset 0 -4px 18px rgba(0,0,0,.6);
    }
    .crt:before{
      content:""; position:absolute; inset:0; background:repeating-linear-gradient(
        to bottom, rgba(255,255,255,.03), rgba(255,255,255,.03) 1px, transparent 1px, transparent 3px
      ); pointer-events:none; mix-blend-mode:overlay; opacity:.35;
    }

    header{
      display:flex; align-items:center; justify-content:space-between; gap:12px; margin-bottom:12px;
    }
    .title{ font-weight:700; letter-spacing:.08em; text-transform:uppercase; color:var(--accent);
      text-shadow:0 0 8px rgba(255,255,255,.35); font-size:1.6rem;
    }

    .hud{ display:flex; align-items:center; gap:12px; flex-wrap:wrap; }
    .scorebox{ background:#0e1726; border:1px solid rgba(255,255,255,.06); padding:8px 12px; border-radius:10px; min-width:100px;
      display:flex; align-items:center; justify-content:space-between; gap:8px; }
    .scorebox .label{opacity:.7; font-size:.9rem}
    .scorebox .value{ font-variant-numeric:tabular-nums; font-weight:700; }

    .controls{ display:flex; gap:10px; align-items:center; }
    .btn{ appearance:none; border:1px solid rgba(255,255,255,.08); background:#101b2b; color:var(--txt); padding:10px 14px; border-radius:10px; cursor:pointer;
      font-weight:600; transition:transform .05s ease, background .2s ease, box-shadow .2s ease; box-shadow:0 4px 14px rgba(0,0,0,.25);
    }
    .btn:hover{ background:#0e1726 }
    .btn:active{ transform:translateY(1px) }
    .btn.primary{ background:#12314a; border-color:#1d4a6c }

    .status{ margin-left:auto; font-size:.9rem; opacity:.9 }

    .board{
      margin-top:12px; display:grid; grid-template-columns:1fr 1fr; grid-template-rows:1fr 1fr; gap:14px;
      width:100%; aspect-ratio:1/1;
    }

    .pad{
      position:relative; border-radius:18px; display:flex; align-items:center; justify-content:center; user-select:none; outline:none; touch-action:manipulation;
      border:2px solid rgba(255,255,255,.06); box-shadow: inset 0 -6px 0 rgba(0,0,0,.25), 0 6px 22px rgba(0,0,0,.35);
      transition:filter .08s linear, transform .08s linear, box-shadow .08s linear, opacity .08s linear;
      overflow:hidden;
    }
    .pad:focus-visible{ box-shadow: inset 0 -6px 0 rgba(0,0,0,.25), 0 0 0 3px #8ecaff, 0 6px 22px rgba(0,0,0,.35); }

    .pad.green{ --glow: var(--green-lit);  background: radial-gradient(80% 80% at 30% 20%, var(--green-lit) 0%, var(--green) 60%); }
    .pad.red{   --glow: var(--red-lit);    background: radial-gradient(80% 80% at 70% 20%, var(--red-lit) 0%, var(--red) 60%); }
    .pad.yellow{--glow: var(--yellow-lit); background: radial-gradient(80% 80% at 30% 80%, var(--yellow-lit) 0%, var(--yellow) 60%); }
    .pad.blue{  --glow: var(--blue-lit);   background: radial-gradient(80% 80% at 70% 80%, var(--blue-lit) 0%, var(--blue) 60%); }

    .pad::after{
      content:""; position:absolute; inset:8% 8% 8% 8%; border-radius:14px; pointer-events:none;
      background: radial-gradient(circle at 30% 25%, rgba(255,255,255,.55), rgba(255,255,255,.18) 35%, rgba(255,255,255,0) 60%);
      opacity:.18; transition:opacity .08s linear, transform .08s linear;
    }

    .pad.lit{ filter:brightness(1.6) saturate(1.3); transform:translateY(1px) scale(1.01);
      box-shadow:
        inset 0 -3px 0 rgba(0,0,0,.18),
        0 0 10px rgba(255,255,255,.12),
        0 0 22px var(--glow),
        0 0 46px var(--glow);
    }
    .pad.lit::after{ opacity:.9; transform:scale(1.02); }

    .shake{ animation:shake .35s linear 1; }
    @keyframes shake{ 0%{transform:translateX(0)} 25%{transform:translateX(-6px)} 50%{transform:translateX(6px)} 75%{transform:translateX(-4px)} 100%{transform:translateX(0)} }

    .overlay{
      position:absolute; inset:0; background:rgba(0,0,0,0.85); color:white; display:flex; flex-direction:column; align-items:center; justify-content:center;
      font-size:1.4rem; text-align:center; padding:20px; gap:20px; z-index:10;
    }

    @media (max-width:380px){
      .scorebox{ min-width:86px }
      .btn{ padding:8px 10px }
    }
  </style>
</head>
<body>
  <div class="shell">
    <div class="screen">
      <div class="crt">
        <header>
          <div class="title">MELOMUSE</div>
          <div class="hud">
            <div class="scorebox" aria-live="polite" aria-atomic="true">
              <span class="label">Score</span>
              <span id="score" class="value">0</span>
            </div>
            <div class="controls">
              <button id="start" class="btn primary" aria-label="Démarrer ou relancer la partie">Nouvelle partie</button>
              <button id="mute" class="btn" aria-pressed="false" aria-label="Activer ou couper le son">Son: ON</button>
            </div>
          </div>
        </header>

        <div id="status" class="status" aria-live="polite">Prêt.</div>

        <div class="board" aria-label="Plateau Simon">
          <button class="pad green"  data-id="0" aria-label="Vert"></button>
          <button class="pad red"    data-id="1" aria-label="Rouge"></button>
          <button class="pad yellow" data-id="2" aria-label="Jaune"></button>
          <button class="pad blue"   data-id="3" aria-label="Bleu"></button>
        </div>
        <div id="overlay" class="overlay" style="display:none"></div>
      </div>
    </div>
  </div>

  <script>
  const pads = Array.from(document.querySelectorAll('.pad'));
  const scoreEl = document.getElementById('score');
  const startBtn = document.getElementById('start');
  const muteBtn  = document.getElementById('mute');
  const statusEl = document.getElementById('status');
  const overlay  = document.getElementById('overlay');

  const FREQUENCIES = [415.30, 310.00, 246.94, 209.00];
  const FAIL_FREQ   = 110;

  let sequence = [];
  let userIndex = 0;
  let score = 0;
  let acceptingInput = false;
  let isMuted = false;

  const AudioCtx = window.AudioContext || window.webkitAudioContext;
  const audioCtx = new AudioCtx();
  let masterGain = audioCtx.createGain();
  masterGain.gain.value = 0.12;
  masterGain.connect(audioCtx.destination);

  function resumeAudio(){ if (audioCtx.state === 'suspended') audioCtx.resume(); }

  function playTone(freq, duration=550, type='square'){
    if (isMuted) return Promise.resolve();
    const osc = audioCtx.createOscillator();
    const gain = audioCtx.createGain();
    osc.type = type; osc.frequency.value = freq;
    gain.gain.setValueAtTime(0.0001, audioCtx.currentTime);
    gain.gain.exponentialRampToValueAtTime(1.0, audioCtx.currentTime + 0.01);
    gain.gain.exponentialRampToValueAtTime(0.001, audioCtx.currentTime + duration/1000);
    osc.connect(gain).connect(masterGain);
    osc.start();
    return new Promise(resolve=>{
      setTimeout(()=>{ osc.stop(); resolve(); }, duration);
    });
  }

  async function playJingle(){
    await playTone(523,200,'square');
    await playTone(659,200,'square');
    await playTone(784,400,'square');
  }

  async function playVictory(){
    await playTone(784,200,'square');
    await playTone(659,200,'square');
    await playTone(523,400,'square');
    await playTone(1046,600,'square');
  }

  function flashPad(id, duration=500){
    const el = pads[id];
    el.classList.add('lit');
    setTimeout(()=> el.classList.remove('lit'), duration);
  }

  function sleep(ms){ return new Promise(r=>setTimeout(r, ms)); }

  async function playStep(id, d=550){
    flashPad(id, d-60);
    await playTone(FREQUENCIES[id], d);
    await sleep(120);
  }

  async function playbackSequence(){
    acceptingInput = false;
    statusEl.textContent = 'Écoute la séquence…';
    for (let i = 0; i < sequence.length; i++){
      await playStep(sequence[i]);
    }
    statusEl.textContent = 'À toi !';
    acceptingInput = true;
  }

  function updateScore(n){
    score = n; scoreEl.textContent = String(score);
  }

  function addRandomStep(){
    const next = Math.floor(Math.random()*4);
    sequence.push(next);
  }

  async function startGame(){
    resumeAudio();
    overlay.style.display = 'none';
    sequence = []; userIndex = 0; updateScore(0);
    addRandomStep();
    await playbackSequence();
  }

  async function handleUserPress(id){
    if (!acceptingInput) return;
    resumeAudio();
    acceptingInput = false;
    flashPad(id, 260);
    await playTone(FREQUENCIES[id], 240);

    if (id === sequence[userIndex]){
      userIndex++;
      if (userIndex === sequence.length){
        updateScore(score + 1);

        if(score === 4){
          await stageReached("Bravo ! Première étape réussie !", playJingle);
          return;
        }
        if(score === 7){
          await stageReached("Félicitations ! Tu as gagné la partie !", playVictory, true);
          return;
        }

        userIndex = 0; addRandomStep();
        await sleep(400);
        await playbackSequence();
      } else {
        acceptingInput = true;
      }
    } else {
      await failEffect();
      statusEl.textContent = 'Raté. Nouvelle partie ?';
    }
  }

  async function stageReached(message, soundFn, end=false){
    acceptingInput = false;
    overlay.innerHTML = `<div>${message}</div><button class="btn primary" id="continueBtn">${end?"Nouvelle partie":"Continuer"}</button>`;
    overlay.style.display = 'flex';
    await soundFn();
    document.getElementById('continueBtn').onclick = ()=>{
      overlay.style.display = 'none';
      if(end){ startGame(); } else {
        userIndex = 0; addRandomStep(); playbackSequence();
      }
    };
  }

  async function failEffect(){
    const board = document.querySelector('.board');
    board.classList.add('shake');
    await playTone(FAIL_FREQ, 700, 'sawtooth');
    await sleep(10);
    board.classList.remove('shake');
    acceptingInput = false;
  }

  startBtn.addEventListener('click', startGame);
  muteBtn.addEventListener('click', ()=>{
    isMuted = !isMuted;
    muteBtn.textContent = 'Son: ' + (isMuted ? 'OFF' : 'ON');
    muteBtn.setAttribute('aria-pressed', String(!isMuted));
  });

  pads.forEach(p=>{
    const id = Number(p.dataset.id);
    p.addEventListener('pointerdown', ()=> handleUserPress(id));
    p.addEventListener('keydown', (e)=>{
      if (e.key === 'Enter' || e.key === ' '){ e.preventDefault(); handleUserPress(id); }
    });
  });

  window.addEventListener('keydown', (e)=>{
    const map = { 'ArrowUp':0, 'ArrowRight':1, 'ArrowDown':2, 'ArrowLeft':3 };
    if (e.key in map){ e.preventDefault(); handleUserPress(map[e.key]); }
  });

  statusEl.textContent = 'Appuie sur “Nouvelle partie”.';
  </script>
</body>
</html>
